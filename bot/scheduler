import sqlite3
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from parsers.ozon import parse_ozon
from parsers.wb import parse_wb
from storage import get_items, update_price

DB_PATH = "/data/market.db"


class PriceScheduler:
    def __init__(self, bot, chat_id):
        self.bot = bot
        self.chat_id = chat_id
        self.scheduler = AsyncIOScheduler()

    def start(self):
        items = get_items()

        for item in items:
            self.add_item_job(item)

        self.scheduler.start()

    def add_item_job(self, item):
        self.scheduler.add_job(
            self.check_item,
            trigger="interval",
            hours=item["interval"],
            args=[item],
            id=f"item_{item['id']}",
            replace_existing=True
        )

    async def check_item(self, item):
        try:
            url = item["url"]

            if "ozon.ru" in url:
                parsed = parse_ozon(url)
            elif "wildberries.ru" in url:
                parsed = parse_wb(url)
            else:
                return

            new_price = parsed["price"]
            old_price = item["price"]

            if new_price != old_price:
                update_price(item["id"], new_price)

                await self.bot.send_message(
                    self.chat_id,
                    f"üìâ –¶–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å!\n\n"
                    f"üì¶ {item['title']}\n"
                    f"–ë—ã–ª–æ: {old_price} ‚ÇΩ\n"
                    f"–°—Ç–∞–ª–æ: {new_price} ‚ÇΩ"
                )

                # –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç –≤ –ø–∞–º—è—Ç–∏
                item["price"] = new_price

        except Exception as e:
            print(f"[Scheduler] Error for {item['title']}: {e}")
